<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DiskWarden</title>
    <link rel="icon" type="image/x-icon" href="/static/favicon.ico">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.7.2/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="static/style.css">
</head>
<body class="night-mode">
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <a class="navbar-brand" href="/">
            <img src="/static/img/diskwarden_title.png" alt="DiskWarden" style="height: 40px;">
        </a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav mr-auto">
                <li class="nav-item">
                    <a class="nav-link" href="/">Disks</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/settings">Settings</a>
                </li>
                <li class="nav-item" id="grafanaNavItem" style="display: none;">
                    <a class="nav-link" id="grafanaLink" href="#" target="_blank" rel="noopener noreferrer">ðŸ“Š Grafana</a>
                </li>
            </ul>
            <div class="form-inline">
                <label class="switch">
                    <input type="checkbox" id="modeToggle" onclick="toggleMode()">
                    <span class="slider"></span>
                </label>
            </div>
        </div>
    </nav>
    <div class="container mt-5">
        <h1 class="text-center page-title">Disk Health Monitor</h1>
        <div class="text-center">
            <button class="btn btn-primary" onclick="fetchDiskHealth()">Refresh Disk Health</button>
            <button class="btn btn-secondary" onclick="scanNow()" id="scanBtn">Scan Now</button>
            <p id="lastUpdated" class="text-muted mt-2"></p>
            <p id="scannerStatus" class="text-muted small"></p>
        </div>
        <table class="table table-striped mt-4">
            <thead class="thead-dark">
                <tr>
                    <th class="sortable" onclick="sortTable(0)">Device <span class="sort-indicator"></span></th>
                    <th class="sortable" onclick="sortTable(1)">Model ID <span class="sort-indicator"></span></th>
                    <th class="sortable" onclick="sortTable(2)">Serial No <span class="sort-indicator"></span></th>
                    <th class="sortable" onclick="sortTable(3)">Size <span class="sort-indicator"></span></th>
                    <th class="sortable" onclick="sortTable(4)">Temperature <span class="sort-indicator"></span></th>
                    <th class="sortable" onclick="sortTable(5)">Highest Temp <span class="sort-indicator"></span></th>
                    <th class="sortable" onclick="sortTable(6)">Health <span class="sort-indicator"></span></th>
                    <th class="sortable" onclick="sortTable(7)">Performance <span class="sort-indicator"></span></th>
                    <th class="sortable" onclick="sortTable(8)">Power on Time <span class="sort-indicator"></span></th>
                    <th class="sortable" onclick="sortTable(9)">Estimated Lifetime <span class="sort-indicator"></span></th>
                </tr>
            </thead>
            <tbody id="diskTableBody">
            </tbody>
        </table>
    </div>
    <script>
        let currentData = [];
        let currentSortColumn = -1;
        let sortAscending = true;
        let lastScanTime = null;

        function fetchDiskHealth() {
            fetch('/api/disk_health')
                .then(response => {
                    if (response.status === 503) {
                        throw new Error('No scan data available - background scanner may not be running');
                    }
                    return response.json();
                })
                .then(data => {
                    // Handle both old format (array) and new format (object with timestamp)
                    if (Array.isArray(data)) {
                        currentData = data;
                        lastScanTime = null;
                    } else {
                        currentData = data.disks || [];
                        lastScanTime = data.last_scan_time;
                    }
                    renderTable(currentData);
                    updateLastUpdated();
                    updateScannerStatus();
                })
                .catch(error => {
                    console.error('Error fetching disk health:', error);
                    alert('Error: ' + error.message);
                });
        }

        function renderTable(data) {
            const tableBody = document.getElementById('diskTableBody');
            tableBody.innerHTML = '';
            data.forEach(disk => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${disk.device}</td>
                    <td>${disk.model_id}</td>
                    <td>${disk.serial_no}</td>
                    <td>${convertSize(disk.size)}</td>
                    <td>${disk.temperature}</td>
                    <td>${disk.highest_temp}</td>
                    <td>${disk.health}</td>
                    <td>${disk.performance}</td>
                    <td>${disk.power_on_time}</td>
                    <td>${disk.lifetime}</td>
                `;
                tableBody.appendChild(row);
            });
        }

        function sortTable(columnIndex) {
            if (currentSortColumn === columnIndex) {
                sortAscending = !sortAscending;
            } else {
                sortAscending = true;
                currentSortColumn = columnIndex;
            }

            const columnNames = ['device', 'model_id', 'serial_no', 'size', 'temperature', 'highest_temp', 'health', 'performance', 'power_on_time', 'lifetime'];
            const columnName = columnNames[columnIndex];

            const sortedData = [...currentData].sort((a, b) => {
                let aVal = a[columnName];
                let bVal = b[columnName];

                // Convert numeric strings to numbers
                if (!isNaN(aVal) && aVal !== '') aVal = parseFloat(aVal);
                if (!isNaN(bVal) && bVal !== '') bVal = parseFloat(bVal);

                if (aVal < bVal) return sortAscending ? -1 : 1;
                if (aVal > bVal) return sortAscending ? 1 : -1;
                return 0;
            });

            updateSortIndicators(columnIndex);
            renderTable(sortedData);
        }

        function updateSortIndicators(columnIndex) {
            const headers = document.querySelectorAll('th.sortable');
            headers.forEach((header, index) => {
                const indicator = header.querySelector('.sort-indicator');
                if (index === columnIndex) {
                    indicator.textContent = sortAscending ? ' â–²' : ' â–¼';
                } else {
                    indicator.textContent = '';
                }
            });
        }

        function convertSize(size) {
            const units = ['MB', 'GB', 'TB'];
            let index = 0;
            let newSize = parseFloat(size);
            while (newSize >= 1024 && index < units.length - 1) {
                newSize /= 1024;
                index++;
            }
            return `${newSize.toFixed(2)} ${units[index]}`;
        }

        function updateLastUpdated() {
            if (!lastScanTime) {
                document.getElementById('lastUpdated').textContent = 'Last updated: No data available';
                return;
            }
            const date = new Date(lastScanTime);
            const formattedDate = date.toLocaleDateString();
            const formattedTime = date.toLocaleTimeString();
            document.getElementById('lastUpdated').textContent = `Last updated: ${formattedDate}, ${formattedTime}`;
        }

        function updateScannerStatus() {
            fetch('/api/status')
                .then(response => response.json())
                .then(data => {
                    let statusText = `Scanner: ${data.scanner_running ? 'âœ“ Running' : 'âœ— Offline'}`;
                    if (data.disks_below_threshold > 0) {
                        statusText += ` | âš ï¸ ${data.disks_below_threshold} disk(s) below threshold`;
                    }
                    if (data.next_scan) {
                        const nextDate = new Date(data.next_scan);
                        statusText += ` | Next scan: ${nextDate.toLocaleTimeString()}`;
                    }
                    document.getElementById('scannerStatus').textContent = statusText;
                })
                .catch(error => console.error('Error fetching status:', error));
        }

        function scanNow() {
            const btn = document.getElementById('scanBtn');
            btn.disabled = true;
            btn.textContent = 'Scanning...';
            
            fetch('/api/scan_now', { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        alert('Scan failed: ' + data.error);
                    } else {
                        // Wait a moment then fetch the new data
                        setTimeout(() => {
                            fetchDiskHealth();
                            updateScannerStatus();
                        }, 500);
                    }
                })
                .catch(error => {
                    console.error('Error triggering scan:', error);
                    alert('Failed to trigger scan');
                })
                .finally(() => {
                    btn.disabled = false;
                    btn.textContent = 'Scan Now';
                });
        }

        function toggleMode() {
            const modeToggle = document.getElementById('modeToggle');
            if (modeToggle.checked) {
                document.body.classList.remove('night-mode');
                document.body.classList.add('day-mode');
                localStorage.setItem('theme', 'day');
            } else {
                document.body.classList.remove('day-mode');
                document.body.classList.add('night-mode');
                localStorage.setItem('theme', 'night');
            }
        }

        function loadTheme() {
            const theme = localStorage.getItem('theme');
            const modeToggle = document.getElementById('modeToggle');
            if (theme === 'day') {
                document.body.classList.add('day-mode');
                modeToggle.checked = true;
            } else {
                document.body.classList.add('night-mode');
                modeToggle.checked = false;
            }
        }

        function updateGrafanaLink() {
            // Load Grafana URL from settings
            fetch('/api/settings')
                .then(response => response.json())
                .then(data => {
                    const grafanaUrl = data.grafanaUrl;
                    if (grafanaUrl && grafanaUrl.trim()) {
                        const navItem = document.getElementById('grafanaNavItem');
                        const link = document.getElementById('grafanaLink');
                        link.href = grafanaUrl;
                        navItem.style.display = 'inline-block';
                    }
                })
                .catch(error => console.log('Could not load Grafana URL'));
        }

        function startAutoRefresh() {
            fetchDiskHealth();
            // Refresh every 30 seconds to show latest cached data from background scanner
            setInterval(fetchDiskHealth, 30000);
        }

        document.addEventListener('DOMContentLoaded', function() {
            loadTheme();
            updateGrafanaLink();
            startAutoRefresh();
        });
    </script>
</body>
</html>