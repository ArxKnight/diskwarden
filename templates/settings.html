<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Settings - DiskWarden</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.7.2/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="static/style.css">
</head>
<body class="night-mode">
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <a class="navbar-brand" href="/">
            <img src="/static/img/diskwarden_title.png" alt="DiskWarden" style="height: 40px;">
        </a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav mr-auto">
                <li class="nav-item">
                    <a class="nav-link" href="/">Disks</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/settings">Settings</a>
                </li>
            </ul>
            <div class="form-inline">
                <label class="switch">
                    <input type="checkbox" id="modeToggle" onclick="toggleMode()">
                    <span class="slider"></span>
                </label>
            </div>
        </div>
    </nav>
    <div class="container mt-5">
        <h1 class="text-center page-title">Settings</h1>
        <div class="card mt-4 notification-section">
            <div class="card-header">
                Health Threshold Settings
            </div>
            <div class="card-body">
                <form id="thresholdForm">
                    <div class="form-group">
                        <label for="healthThreshold">Health Threshold (%)</label>
                        <small class="form-text text-muted">Set the health percentage threshold for sending notifications about disk health to your Discord server and email.</small>
                        <select class="form-control" id="healthThreshold" required style="width: auto;">
                            <option value="10">10%</option>
                            <option value="20">20%</option>
                            <option value="30">30%</option>
                            <option value="40">40%</option>
                            <option value="50">50%</option>
                            <option value="60">60%</option>
                            <option value="70">70%</option>
                            <option value="80">80%</option>
                            <option value="90">90%</option>
                        </select>
                    </div>
                    <button type="submit" class="btn btn-primary">Save Threshold</button>
                </form>
            </div>
        </div>
        <div class="card mt-4 notification-section">
            <div class="card-header">
                Discord Notification Settings
            </div>
            <div class="card-body">
                <form id="settingsForm">
                    <div class="form-group">
                        <label for="webhookUrl">Discord Webhook URL</label>
                        <small class="form-text text-muted">Add a webhook URL to send notifications to your discord server when the health of a disk goes under your specified value.</small>
                        <input type="url" class="form-control" id="webhookUrl" required>
                    </div>
                    <button type="submit" class="btn btn-primary">Save Settings</button>
                    <button type="button" class="btn btn-secondary" onclick="sendTestMessage()">Send Test Message</button>
                </form>
            </div>
        </div>
        <div class="card mt-4 notification-section">
            <div class="card-header">
                Email Notification Settings
            </div>
            <div class="card-body">
                <form id="emailSettingsForm">
                    <div class="form-group">
                        <label for="smtpServer">SMTP Server</label>
                        <small class="form-text text-muted">Enter your email provider's SMTP server address.</small>
                        <input type="text" class="form-control" id="smtpServer" required>
                    </div>
                    <div class="form-group">
                        <label for="smtpPort">SMTP Port</label>
                        <small class="form-text text-muted">Enter your email provider's SMTP port number (default is 587).</small>
                        <input type="number" class="form-control" id="smtpPort" required>
                    </div>
                    <div class="form-group">
                        <label for="email">Email</label>
                        <small class="form-text text-muted">Enter the email address to send notifications from.</small>
                        <input type="email" class="form-control" id="email" required>
                    </div>
                    <div class="form-group">
                        <label for="emailPassword">Email Password</label>
                        <small class="form-text text-muted">Enter the password for the email address.</small>
                        <input type="password" class="form-control" id="emailPassword" required>
                    </div>
                    <button type="submit" class="btn btn-primary">Save Email Settings</button>
                    <button type="button" class="btn btn-secondary" onclick="sendTestEmail()">Send Test Email</button>
                </form>
            </div>
        </div>
        <div id="notification" class="alert mt-3" role="alert" style="display: none;"></div>
    </div>
    <script>
        document.getElementById('settingsForm').addEventListener('submit', function(event) {
            event.preventDefault();
            const webhookUrl = document.getElementById('webhookUrl').value;
            fetch('/api/settings', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ webhookUrl }),
            })
            .then(response => response.json())
            .then(data => {
                const notification = document.getElementById('notification');
                notification.innerText = 'Discord settings saved successfully!';
                notification.className = 'alert alert-success';
                notification.style.display = 'block';
                setTimeout(() => {
                    notification.style.display = 'none';
                }, 5000);
            })
            .catch(error => {
                const notification = document.getElementById('notification');
                notification.innerText = 'Failed to save Discord settings.';
                notification.className = 'alert alert-danger';
                notification.style.display = 'block';
                setTimeout(() => {
                    notification.style.display = 'none';
                }, 5000);
                console.error('Error saving Discord settings:', error);
            });
        });

        document.getElementById('thresholdForm').addEventListener('submit', function(event) {
            event.preventDefault();
            const healthThreshold = document.getElementById('healthThreshold').value;
            fetch('/api/settings', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ healthThreshold }),
            })
            .then(response => response.json())
            .then(data => {
                const notification = document.getElementById('notification');
                notification.innerText = 'Health threshold saved successfully!';
                notification.className = 'alert alert-success';
                notification.style.display = 'block';
                setTimeout(() => {
                    notification.style.display = 'none';
                }, 5000);
            })
            .catch(error => {
                const notification = document.getElementById('notification');
                notification.innerText = 'Failed to save health threshold.';
                notification.className = 'alert alert-danger';
                notification.style.display = 'block';
                setTimeout(() => {
                    notification.style.display = 'none';
                }, 5000);
                console.error('Error saving health threshold:', error);
            });
        });

        document.getElementById('emailSettingsForm').addEventListener('submit', function(event) {
            event.preventDefault();
            const smtpServer = document.getElementById('smtpServer').value;
            const smtpPort = document.getElementById('smtpPort').value;
            const email = document.getElementById('email').value;
            const emailPassword = document.getElementById('emailPassword').value;
            fetch('/api/email_settings', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ smtpServer, smtpPort, email, emailPassword }),
            })
            .then(response => response.json())
            .then(data => {
                const notification = document.getElementById('notification');
                notification.innerText = 'Email settings saved successfully!';
                notification.className = 'alert alert-success';
                notification.style.display = 'block';
                setTimeout(() => {
                    notification.style.display = 'none';
                }, 5000);
            })
            .catch(error => {
                const notification = document.getElementById('notification');
                notification.innerText = 'Failed to save email settings.';
                notification.className = 'alert alert-danger';
                notification.style.display = 'block';
                setTimeout(() => {
                    notification.style.display = 'none';
                }, 5000);
                console.error('Error saving email settings:', error);
            });
        });

        function sendTestMessage() {
            const webhookUrl = document.getElementById('webhookUrl').value;
            if (!webhookUrl) {
                const notification = document.getElementById('notification');
                notification.innerText = 'Please enter a webhook URL to send a test message.';
                notification.className = 'alert alert-warning';
                notification.style.display = 'block';
                setTimeout(() => {
                    notification.style.display = 'none';
                }, 5000);
                return;
            }
            fetch('/api/test_message', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ webhookUrl }),
            })
            .then(response => response.json())
            .then(data => {
                const notification = document.getElementById('notification');
                notification.innerText = 'Test message sent successfully!';
                notification.className = 'alert alert-success';
                notification.style.display = 'block';
                setTimeout(() => {
                    notification.style.display = 'none';
                }, 5000);
            })
            .catch(error => {
                const notification = document.getElementById('notification');
                notification.innerText = 'Failed to send test message.';
                notification.className = 'alert alert-danger';
                notification.style.display = 'block';
                setTimeout(() => {
                    notification.style.display = 'none';
                }, 5000);
                console.error('Error sending test message:', error);
            });
        }

        function sendTestEmail() {
            const email = document.getElementById('email').value;
            if (!email) {
                const notification = document.getElementById('notification');
                notification.innerText = 'Please enter an email address to send a test email.';
                notification.className = 'alert alert-warning';
                notification.style.display = 'block';
                setTimeout(() => {
                    notification.style.display = 'none';
                }, 5000);
                return;
            }
            fetch('/api/test_email', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ email }),
            })
            .then(response => response.json())
            .then(data => {
                const notification = document.getElementById('notification');
                notification.innerText = 'Test email sent successfully!';
                notification.className = 'alert alert-success';
                notification.style.display = 'block';
                setTimeout(() => {
                    notification.style.display = 'none';
                }, 5000);
            })
            .catch(error => {
                const notification = document.getElementById('notification');
                notification.innerText = 'Failed to send test email.';
                notification.className = 'alert alert-danger';
                notification.style.display = 'block';
                setTimeout(() => {
                    notification.style.display = 'none';
                }, 5000);
                console.error('Error sending test email:', error);
            });
        }

        function toggleMode() {
            const modeToggle = document.getElementById('modeToggle');
            if (modeToggle.checked) {
                document.body.classList.remove('night-mode');
                document.body.classList.add('day-mode');
                localStorage.setItem('theme', 'day');
            } else {
                document.body.classList.remove('day-mode');
                document.body.classList.add('night-mode');
                localStorage.setItem('theme', 'night');
            }
        }

        function loadTheme() {
            const theme = localStorage.getItem('theme');
            const modeToggle = document.getElementById('modeToggle');
            if (theme === 'day') {
                document.body.classList.add('day-mode');
                modeToggle.checked = true;
            } else {
                document.body.classList.add('night-mode');
                modeToggle.checked = false;
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            loadTheme();
        });

        // Load existing settings
        fetch('/api/settings')
            .then(response => response.json())
            .then(data => {
                document.getElementById('webhookUrl').value = data.webhookUrl || '';
                document.getElementById('healthThreshold').value = data.healthThreshold || '90';
                document.getElementById('smtpServer').value = data.smtpServer || '';
                document.getElementById('smtpPort').value = data.smtpPort || 587;
                document.getElementById('email').value = data.email || '';
                document.getElementById('emailPassword').value = data.emailPassword || '';
            })
            .catch(error => {
                console.error('Error loading settings:', error);
            });
    </script>
</body>
</html>